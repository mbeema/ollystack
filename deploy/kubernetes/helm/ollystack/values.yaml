# OllyStack Enterprise Helm Values
#
# Simplified architecture: Agent → Ingestion Gateway → ClickHouse (Direct)
# No Kafka required - simpler, cheaper, easier to operate
#
# Optimized for:
# - Unlimited scale (auto-scaling based on load)
# - High availability (99.99% uptime)
# - Cost efficiency (no Kafka overhead)

global:
  # Image configuration
  imageRegistry: ""
  imagePullSecrets: []

  # Storage class for persistent volumes
  storageClass: "gp3"  # AWS EBS gp3 for best price/performance

  # Environment
  environment: production

# ============================================================================
# Ingestion Gateway - Receives OTLP, writes directly to ClickHouse
# ============================================================================
ingestionGateway:
  enabled: true

  replicaCount: 3  # Minimum replicas

  image:
    repository: ollystack/ingestion-gateway
    tag: "2.0.0"
    pullPolicy: IfNotPresent

  # Auto-scaling configuration
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 100
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    # Custom metrics for scaling
    customMetrics:
      - type: Pods
        pods:
          metric:
            name: ollystack_ingestion_requests_per_second
          target:
            type: AverageValue
            averageValue: "5000"  # Scale at 5k RPS per pod

  resources:
    requests:
      cpu: "500m"
      memory: "256Mi"
    limits:
      cpu: "2000m"
      memory: "512Mi"

  # Pod disruption budget for high availability
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  # Topology spread for multi-AZ
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app: ingestion-gateway

  service:
    type: LoadBalancer
    annotations:
      # AWS NLB for high throughput
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    ports:
      grpc: 4317
      http: 4318
      metrics: 8888

  # ClickHouse connection (direct write)
  clickhouse:
    host: "clickhouse"
    port: 9000
    database: "ollystack"
    username: "ollystack"
    passwordSecret: ollystack-clickhouse-credentials
    passwordSecretKey: password
    batchSize: 10000
    flushIntervalMs: 1000

  # Sampling configuration
  sampling:
    enabled: true
    defaultRate: 0.1  # 10% default sampling
    errorRate: 1.0    # 100% of errors
    slowRate: 1.0     # 100% of slow requests
    slowThresholdMs: 1000
    adaptiveEnabled: true

  # Rate limiting
  rateLimit:
    enabled: true
    defaultRPS: 10000
    defaultBurst: 20000

# ============================================================================
# Real-time Processor - Alert evaluation (queries ClickHouse MVs)
# ============================================================================
realtimeProcessor:
  enabled: true

  replicaCount: 2

  image:
    repository: ollystack/realtime-processor
    tag: "2.0.0"

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 16
    targetCPUUtilizationPercentage: 60  # Keep headroom for burst

  resources:
    requests:
      cpu: "250m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"

  # Alert configuration
  alerting:
    alertmanagerUrl: "http://alertmanager:9093"
    evaluationIntervalMs: 1000  # Query MVs every 1 second

# ============================================================================
# API Server
# ============================================================================
apiServer:
  enabled: true

  replicaCount: 3

  image:
    repository: ollystack/api-server
    tag: "2.0.0"

  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 70

  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

  service:
    type: ClusterIP
    port: 8080

# ============================================================================
# AI Engine
# ============================================================================
aiEngine:
  enabled: true

  replicaCount: 2

  image:
    repository: ollystack/ai-engine
    tag: "2.0.0"

  resources:
    requests:
      cpu: "1000m"
      memory: "2Gi"
    limits:
      cpu: "4000m"
      memory: "8Gi"

  # LLM configuration
  llm:
    provider: "anthropic"  # or "openai"
    model: "claude-3-sonnet"
    # API key from secret
    apiKeySecret: ollystack-llm-credentials
    apiKeySecretKey: api-key

# ============================================================================
# Web UI
# ============================================================================
webUI:
  enabled: true

  replicaCount: 2

  image:
    repository: ollystack/web-ui
    tag: "2.0.0"

  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: app.ollystack.io
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: ollystack-tls
        hosts:
          - app.ollystack.io

# ============================================================================
# ClickHouse Configuration
# ============================================================================
clickhouse:
  enabled: true

  # Shards and replicas
  shards: 4
  replicaCount: 3  # Replicas per shard

  # Authentication
  auth:
    username: default
    existingSecret: ollystack-clickhouse-credentials
    existingSecretKey: password

  # Resource allocation (per replica)
  resources:
    requests:
      cpu: "2000m"
      memory: "8Gi"
    limits:
      cpu: "8000m"
      memory: "32Gi"

  persistence:
    enabled: true
    size: 1Ti
    storageClass: "gp3"

  # Performance settings
  extraConfig: |
    <clickhouse>
      <profiles>
        <default>
          <max_memory_usage>25000000000</max_memory_usage>
          <max_threads>8</max_threads>
          <max_execution_time>300</max_execution_time>
        </default>
      </profiles>
      <merge_tree>
        <max_suspicious_broken_parts>5</max_suspicious_broken_parts>
      </merge_tree>
    </clickhouse>

  # Tiered storage configuration
  tieredStorage:
    enabled: true
    warmVolumeSize: 2Ti
    coldBucket: "s3://ollystack-cold-storage"
    coldBucketRegion: "us-east-1"

# ============================================================================
# Redis Configuration
# ============================================================================
redis:
  enabled: true

  architecture: replication

  master:
    resources:
      requests:
        cpu: "250m"
        memory: "256Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"
    persistence:
      enabled: true
      size: 10Gi

  replica:
    replicaCount: 2
    resources:
      requests:
        cpu: "250m"
        memory: "256Mi"

  sentinel:
    enabled: true

# ============================================================================
# AlertManager
# ============================================================================
alertmanager:
  enabled: true

  replicaCount: 3

  image:
    repository: prom/alertmanager
    tag: "v0.27.0"

  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"

  persistence:
    enabled: true
    size: 10Gi

  config:
    global:
      resolve_timeout: 5m
    route:
      receiver: default
      group_by: ['alertname', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
    receivers:
      - name: default
        webhook_configs:
          - url: 'http://api-server:8080/api/v1/alerts/webhook'

# ============================================================================
# Monitoring (Self-monitoring)
# ============================================================================
monitoring:
  enabled: true

  # ServiceMonitor for Prometheus
  serviceMonitor:
    enabled: true
    interval: 15s

  # Grafana dashboards
  grafana:
    enabled: true
    dashboards:
      - name: ollystack-overview
      - name: ollystack-ingestion
      - name: ollystack-storage
      - name: ollystack-queries

# ============================================================================
# Security
# ============================================================================
security:
  # Network policies
  networkPolicies:
    enabled: true

  # Pod security
  podSecurityPolicy:
    enabled: false  # Deprecated in K8s 1.25+

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000

  # TLS
  tls:
    enabled: true
    certManager:
      enabled: true
      issuer: letsencrypt-prod

# ============================================================================
# Cost Optimization
# ============================================================================
costOptimization:
  # Spot instances for non-critical workloads
  spotInstances:
    enabled: true
    components:
      - aiEngine

  # Resource right-sizing
  verticalPodAutoscaler:
    enabled: true

  # Scheduled scaling (reduce at night)
  scheduledScaling:
    enabled: false
    schedules:
      - name: night-reduction
        minReplicas: 2
        schedule: "0 22 * * *"  # 10 PM
      - name: day-increase
        minReplicas: 4
        schedule: "0 6 * * *"   # 6 AM
